---

- name: IBM MQ Certificate Renewal - Precheck
  hosts: all_servers
  gather_facts: false

  tasks:

    ######################################################################
    # STEP 1 — Validate MQ SSL directory exists
    ######################################################################
    - name: Check MQ SSL directory
      stat:
        path: "{{ ssl_dir }}"
      register: ssl_dir_stat

    - fail:
        msg: "SSL directory does not exist: {{ ssl_dir }}"
      when: not ssl_dir_stat.stat.exists


    ######################################################################
    # STEP 2 — Validate KDB file and STH file exist
    ######################################################################
    - name: Check KDB and STH files
      stat:
        path: "{{ item }}"
      loop:
        - "{{ kdb_file }}"
        - "{{ sth_file }}"
      register: kdb_stat_result

    - fail:
        msg: "Missing MQ keystore file: {{ item.item }}"
      when: not item.stat.exists
      loop: "{{ kdb_stat_result.results }}"


    ######################################################################
    # STEP 3 — Validate stash decrypts the KDB
    ######################################################################
    - name: Validate stash decrypts KDB
      command: runmqakm -cert -list -db {{ kdb_file }} -stashed
      register: stash_test
      changed_when: false
      failed_when: stash_test.rc != 0


    ######################################################################
    # STEP 4 — Validate Artifactory credentials (token)
    ######################################################################
    - name: Validate Artifactory token with a HEAD request
      uri:
        url: "{{ artifactory_url }}"
        method: HEAD
        headers:
          Authorization: "Bearer {{ artifactory_token }}"
        return_content: false
        status_code: 200
      register: artifactory_check
      failed_when: artifactory_check.status != 200
      no_log: true


    ######################################################################
    # STEP 5 — Validate remote connection to MQ listener port
    ######################################################################
    - name: Test MQ listener port is reachable
      wait_for:
        host: "{{ inventory_hostname }}"
        port: "{{ host_port }}"
        timeout: 5


    ######################################################################
    # STEP 6 — TLS handshake preview (no cert renewal yet)
    ######################################################################
    - name: TLS precheck handshake
      shell: |
        timeout 10 openssl s_client -connect {{ inventory_hostname }}:{{ host_port }} </dev/null 2>&1
      register: tls_precheck
      changed_when: false

    - fail:
        msg: "TLS precheck handshake failed on {{ inventory_hostname }}. Review SSL config."
      when: "'Verify return code' not in tls_precheck.stdout"

